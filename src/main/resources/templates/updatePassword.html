<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Change password</title>
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/corner.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <style>
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        form button {
            padding: 10px;
            font-size: 17px;
            border-radius: 15px;
            min-width: 100px;
        }

        form input {
            padding: 10px;
            font-size: 14px;
            border: none;
            outline: none;
            border-radius: 17px;
            max-width: 500px;
            transition: background-color 200ms ease-in-out;
            width: 100%;
        }
    </style>
</head>
<body class="standard" id="loginBody">
    <section class="loginContent">
        <h1>Reset password</h1>
        <form>
            <br/>
            <label for="password">Password: </label>
            <input id="password" type="password" name="newPassword" required/>
            <br/>

            <label for="matchPassword">Confirm password: </label>
            <input id="matchPassword" type="password" name="matchPassword"/>
            <br/><br/>

<!--            <label for="token">Token:</label>-->
            <input id="token" name="token" th:value="${token}" style="display: none" />
            <div id="globalError" class="alert alert-error" style="display:none">Passwords have to match</div>

            <button type="submit">Reset</button>
        </form>

<!--        <form method="POST" th:action="@{/savePassword}" th:object="${passwordDto}">-->
<!--            <br/>-->
<!--            <label for="password">Password: </label>-->
<!--            <input id="password" type="password" name="newPassword" th:field="*{newPassword}" required/>-->
<!--            <br/>-->

<!--            <label for="matchPassword">Confirm password: </label>-->
<!--            <input id="matchPassword" type="password" name="matchPassword" th:field="*{matchPassword}" required/>-->
<!--            <br/><br/>-->

<!--            &lt;!&ndash;            <label for="token">Token:</label>&ndash;&gt;-->
<!--            <h1 th:text="${token}"></h1>-->
<!--            <input id="token" name="token" th:value="${token}" th:field="*{token}" style="display: none"/>-->
<!--            <div id="globalError" class="alert alert-error" style="display:none">Passwords have to match</div>-->

<!--            <button type="submit">Reset</button>-->
<!--        </form>-->
    </section>

    <script th:inline="javascript">
        let serverContext = [[@{/}]];

        $(document).ready(function () {
            $('form').submit(function(event) {
                savePass(event);
            });

            $(":password").keyup(function(){
                if($("#password").val() !== $("#matchPassword").val()){
                    $("#globalError").show().html("Passwords have to match");
                }else{
                    $("#globalError").html("").hide();
                }
            });
        });

        function savePass(event) {
            event.preventDefault();
            $(".alert").html("").hide();
            if($("#password").val() !== $("#matchPassword").val()){
                $("#globalError").show().html("Passwords have to match");
                return;
            }

            let formData= $('form').serialize();
            console.log(formData);
            let csrfToken = $("meta[name='_csrf']").attr("content");
            let csrfHeader = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: serverContext + "savePassword",
                type: "POST",
                data: formData,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(data) {
                    window.location.href = serverContext + "login?message=Password has been successfully reset";
                },
                error: function(data) {
                    if (data.responseJSON && data.responseJSON.error.indexOf("InternalError") > -1) {
                        window.location.href = serverContext + "login?message=Error";
                    } else {
                        let errors = $.parseJSON(data.responseJSON.message);
                        $.each(errors, function(index, item) {
                            $("#globalError").show().html(item.defaultMessage);
                        });

                        errors = $.parseJSON(data.responseJSON.error);
                        $.each(errors, function(index, item) {
                            $("#globalError").show().append(item.defaultMessage + "<br/>");
                        });
                    }
                }
            });
        }
    </script>
</body>
</html>